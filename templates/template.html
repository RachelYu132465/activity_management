<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ (eventNames[0] if eventNames) or "手冊" }}</title>

    <style>
        /* A4 印刷基礎 */
        @page { size: A4; margin: 18mm; }
        html, body { margin:0; padding:0; -webkit-print-color-adjust: exact; }

        /* 如需在 screen 與 print 分別處理 */
        @media print {
          /* 強制列印背景與色彩精確度 */
          html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }

        body {
          font-family: "Noto Sans TC", "Helvetica", "Arial", sans-serif;
          color: #111;
          /* font-size: 12pt; */
          line-height: 1.45;
          padding: 12mm;
          box-sizing: border-box;
        }

        /* ---------- 公用：確保一頁至少佔滿 A4（扣 margin） ---------- */
        /* A4 height = 297mm. margins top+bottom = 18mm*2 = 36mm */
        .page-full {
          page-break-after: always;
          page-break-inside: avoid;
          min-height: calc(297mm - 36mm); /* 確保至少一頁 */
          display: block;
          padding-top: 10mm;
          padding-bottom: 10mm;
          box-sizing: border-box;
        }
        .page-full:last-child { page-break-after: auto; }

        /* 封面：由上往下堆（logo/title/meta 在上方），再用 spacer 推底部區塊 */
        .cover {
          text-align:center;
          display:flex;
          flex-direction:column;
          justify-content:flex-start; /* 從上方開始堆疊 */
          box-sizing: border-box;
        }

        /* 讓 page-full.cover 成為定位參考 */
        .page-full.cover { position: relative; }
        .title { font-size: 28pt; text-align:center; }

        /* 讓 title 在整頁中心（水平 + 垂直） */
        .page-full.cover .title {
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          width: calc(210mm - 36mm);  /* = 174mm */
          max-width: calc(210mm - 36mm);
          box-sizing: border-box;
          padding: 0 6mm;
          text-align: center;
          font-weight: 700;
          z-index: 10;
          word-wrap: break-word;
        }

        .inner-text {
          font-size:14pt;
          font-weight:700;
        }

        /* spacer：把參與單位推到底 */
        .cover .spacer { flex: 1 1 auto; }

        .participation {
          margin-top:12px;
          align-self: flex-start;
          text-align: left;
          width:100%;
          box-sizing: border-box;
          padding-left: 6mm;
          padding-right: 12mm;
        }
        .participation p { margin:6px 0; }

        /* 目錄 */
        .toc h2 { margin-bottom:8px; }
        .toc ol { padding-left:1.1em; }

        /* 論壇資訊 */
        .forum-info p { margin:6px 0; }

        /* 論壇須知 */
        .notes ul { margin:6px 0 0 18px;}

        /* 議程 */
        table.schedule { border-collapse: collapse; margin-top:8px; }
        table.schedule th, table.schedule td {
          border:1px solid #ddd; padding:6px 8px; vertical-align:top; font-size:11pt;
        }
        table.schedule th { background:#f3f3f3; font-weight:600; text-align:left; }

        /* 主持人 / 講者頁面樣式 */
        .person-card { display:flex; gap:18px; align-items:flex-start; }
        .person-photo { width:120px; flex: 0 0 120px; }
        .person-info { flex:1; }
        .person-info .name { font-size:18pt; font-weight:700; margin-bottom:6px; }
        .person-info .title { font-size:12pt; color:#333; margin-bottom:8px; }
        .person-info .bio { font-size:11pt; white-space:pre-wrap; }

        /* 小字 footer */
        footer.small { font-size:10pt; color:#666; margin-top:10mm; text-align:left; }

        /* print tweaks */
        @media print { body { padding: 6mm; } }

        /* A4 trim visual helper (preview only). 如果需要出血，請在輸出流程處理。 */
        .trim-box {
          width: 210mm;
          height: 297mm;
          margin: 3mm auto;
          box-sizing: border-box;
          outline: 0.5pt dashed rgba(0,0,0,0.2);
        }

        .safe { padding: 8mm; }
        img { max-width: 100%; height: auto; }

    </style>
</head>
<body>

<div id="test-field">{{ test_influencer }}</div>

<div class="page-full cover">
    {% if assets.logo_url|default('') %}
    <img src="{{ assets.logo_url }}" alt="logo" style="max-height:90px; margin-bottom:8px;">
    {% endif %}

    <div class="title">{{ eventNames[0] }}</div>

    <div class="spacer"></div>

    <div class="participation inner-text" aria-label="參與單位">
        <p>指導單位：{{ instructors | join('、') }}</p>
        <p>主辦單位：{{ organizers | join('、') }}</p>
        {% if jointOrganizers|default([]) %}
        <p>合辦單位：{{ jointOrganizers | join('、') }}</p>
        {% endif %}
        {% if coOrganizers|default([]) %}
        <p>協辦單位：{{ coOrganizers | join('、') }}</p>
        {% endif %}

        <div style="margin-top:8px;">
            <span class="inner-text">日期：</span>
            <span class="inner-text js-date" data-iso="{{ date }}">{{ date }}</span>
        </div>

        <p>地點：{{ locations[0] }}{% if locations|length > 1 %}<br> ({{ locations[1] }}){% endif %}</p>
    </div>
</div>

<nav class="page-full title" aria-label="目錄 Contents">
    <h2>目錄 / Contents</h2>
    <ol class="inner-text">
        <li>論壇須知 / Notes</li>
        <li>議程 / Schedule</li>
        <li>主持人 / Chairs</li>
        <li>講者 / Speakers</li>
    </ol>
</nav>

<section class="page-full notes" aria-label="論壇須知 Notes">
    <h2>論壇須知 / Notes</h2>
    <ul>
        <li>本次活動報到時間為上午09:30-10:00。</li>
        <li>本次活動將申請公務人員終身學習時數，請於休息時間簽到。</li>
        <li>為尊重智慧財產權，本論壇禁止側錄主講人簡報。</li>
        <li>本次課程場地配置圖請參考下圖。</li>
        <li>
            <img src="{{ url_for('static', filename='802.png') }}" alt="場地配置圖 / Venue layout" width="500" height="600">
        </li>
        <li>滿意度問卷</li>
        <li><img src="{{ url_for('static', filename='frame.png') }}" alt="問卷框架 / Survey frame" width="500" height="600"></li>
    </ul>
</section>

<section class="page-full">
    <h2>議程 / Schedule</h2>
    <table class="schedule" role="table" aria-label="議程表" style="width:17.4cm;">
        <colgroup>
            <col style="width:3.0cm;">
            <col style="width:9.6cm;">
            <col style="width:4.8cm;">
        </colgroup>
        <thead>
        <tr>
            <th>時間 / Time</th>
            <th>主題 / Topic</th>
            <th>講者 / Speaker</th>
        </tr>
        </thead>
        <tbody>
        {% for item in schedule %}
        {% if item.kind == 'host' %}
        <tr>
            <td colspan="3">{{ item.text }}</td>
        </tr>
        {% elif item.kind == 'break' or item.kind == 'special' %}
        <tr>
            <td>{{ item.time }}</td>
            <td colspan="2">{{ item.topic }}{% if item.speaker %}<br>{{ item.speaker }}{% endif %}</td>
        </tr>
        {% else %}
        <tr>
            <td>{{ item.time }}</td>
            <td>{{ item.topic }}</td>
            <td>{{ item.speaker or '' }}</td>
        </tr>
        {% endif %}
        {% endfor %}
        </tbody>
    </table>
</section>

{% for chair in chairs %}
<section class="page-full" aria-label="主持人 Chair">
    <h2>主持人 / Chair</h2>
    <div class="person-card">
        {% if chair.photo_url %}
        <div class="person-photo"><img src="{{ chair.photo_url }}" alt="{{ chair.name }} 照片" style="width:100%; height:auto;"></div>
        {% endif %}
        <div class="person-info">
            <div class="name">{{ chair.name }}</div>
            <div class="title">{{ chair.title }}</div>
            <div class="bio">{{ chair.highest_education.school }} </div>
        </div>
    </div>
</section>
{% endfor %}

{% for sp in speakers %}
<section class="page-full" aria-label="講者 Speaker">
    <h2>講者 / Speaker</h2>
    <div class="person-card">
        {% if sp.photo_url %}
        <div class="person-photo"><img src="{{ sp.photo_url }}" alt="{{ sp.name }} 照片" style="width:100%; height:auto;"></div>
        {% endif %}
        <div class="person-info">
            <div class="name">{{ sp.name }}</div>
            <div class="title">{{ sp.title }}</div>
            <div class="bio">{{ sp.profile or "" }}</div>
        </div>
    </div>
</section>
{% endfor %}

<footer class="small">
    來源：依據上傳手冊內容製作。 Generated from the uploaded handbook.
</footer>

<!-- 把 script 放在 body 結尾（但在 </body> 之前） -->
<script>
    (function(){
      // 使用 Intl 產生本地化（zh-TW）年月日 + 星期（長格式）
      const formatter = new Intl.DateTimeFormat('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long'
      });

      function parseDateAvoidTZ(s){
        if(!s) return null;
        s = String(s).trim();
        // YYYY-MM-DD or YYYY/MM/DD
        let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
        if(m){ return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3])); }
        // YYYYMMDD
        m = s.match(/^(\d{4})(\d{2})(\d{2})$/);
        if(m){ return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3])); }
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }

      document.querySelectorAll('.js-date').forEach(el=>{
        const raw = el.dataset.iso || el.textContent || '';
        const d = parseDateAvoidTZ(raw);
        if(!d) return;
        el.textContent = formatter.format(d);
      });
    })();
</script>
</body>
</html>
